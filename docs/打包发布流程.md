# 📦 打包和发布流程文档

本文档详细说明如何打包和发布 SVN/Git 自动提交插件。

## 📋 目录

- [前置准备](#前置准备)
- [打包流程](#打包流程)
- [发布流程](#发布流程)
- [版本管理](#版本管理)
- [故障排除](#故障排除)

---

## 🔧 前置准备

### 1. 安装必要工具

#### 安装 vsce（VSCode Extension Manager）

```bash
# 全局安装 vsce
npm install -g @vscode/vsce

# 或者使用 npx（推荐，无需全局安装）
npx @vscode/vsce --version
```

#### 验证安装

```bash
vsce --version
# 应该显示版本号，例如：2.22.0
```

### 2. 准备发布令牌（Personal Access Token）

#### 创建 Azure DevOps 组织（如果还没有）

1. 访问 https://dev.azure.com
2. 创建或登录组织
3. 记录组织名称（例如：`QINGYUAI`）

#### 创建 Personal Access Token

1. 访问：https://dev.azure.com/{组织名}/_usersSettings/tokens
2. 点击 "New Token"
3. 配置：
   - **Name**: `VSCode Extension Publishing`
   - **Organization**: 选择你的组织
   - **Expiration**: 设置过期时间（建议1年）
   - **Scopes**: 选择 `Custom defined`
   - **Marketplace**: 选择 `Manage` 权限
4. 点击 "Create"
5. **重要**：复制并保存令牌（只显示一次）

### 3. 登录 vsce

```bash
# 使用 Personal Access Token 登录
vsce login QINGYUAI

# 输入你的 Personal Access Token
# 成功后会在 ~/.vsce 中保存凭证
```

---

## 📦 打包流程

### 步骤 1: 检查项目状态

```bash
# 确保所有更改已提交
git status

# 确保代码编译通过
npm run compile
```

### 步骤 2: 更新版本号

在 `package.json` 中更新版本号：

```json
{
  "version": "0.1.2"  // 根据语义化版本更新
}
```

**版本号规则**：
- **主版本号（Major）**: 不兼容的 API 修改
- **次版本号（Minor）**: 向下兼容的功能性新增
- **修订号（Patch）**: 向下兼容的问题修正

### 步骤 3: 更新 CHANGELOG.md

在 `CHANGELOG.md` 中添加新版本的更新内容：

```markdown
## [0.1.2] - 2025-11-20

### ✨ 新增功能
- 新增功能描述

### 🔄 改进优化
- 优化内容描述

### 🐛 问题修复
- 修复内容描述
```

### 步骤 4: 运行代码检查

```bash
# 运行 ESLint 检查
npm run lint

# 运行测试（如果有）
npm test
```

### 步骤 5: 编译项目

```bash
# 开发模式编译（带 source map）
npm run compile

# 或生产模式编译（优化后）
npm run package
```

**编译输出**：
- 文件位置：`dist/extension.js`
- Source Map：`dist/extension.js.map`（开发模式）

### 步骤 6: 打包成 VSIX 文件

```bash
# 方法一：使用 vsce package（推荐）
vsce package

# 方法二：指定输出目录
vsce package -o release/

# 方法三：包含 yarn 依赖（如果使用 yarn）
vsce package --yarn
```

**打包输出**：
- 文件位置：`svn-git-auto-commit-0.1.2.vsix`
- 文件大小：通常 40-50 KB

### 步骤 7: 验证 VSIX 文件

```bash
# 检查 VSIX 文件内容
vsce ls

# 或手动解压查看（VSIX 是 ZIP 格式）
# Windows: 重命名为 .zip 后解压
# Linux/Mac: unzip svn-git-auto-commit-0.1.2.vsix
```

**验证清单**：
- [ ] `package.json` 存在且版本号正确
- [ ] `dist/extension.js` 存在且已编译
- [ ] `icon.png` 存在
- [ ] `README.md` 存在
- [ ] `CHANGELOG.md` 存在
- [ ] `LICENSE` 存在
- [ ] 没有包含源代码文件（`src/**`）
- [ ] 没有包含开发文件（`node_modules/**`, `test/**`）

---

## 🚀 发布流程

### 方法一：发布到 VSCode Marketplace（推荐）

#### 步骤 1: 发布新版本

```bash
# 发布新版本（会自动打包）
vsce publish

# 或指定版本号
vsce publish 0.1.2

# 或发布补丁版本（自动递增）
vsce publish patch

# 或发布次版本（自动递增）
vsce publish minor

# 或发布主版本（自动递增）
vsce publish major
```

#### 步骤 2: 等待发布完成

发布过程会：
1. 自动运行 `vscode:prepublish` 脚本（编译代码）
2. 打包成 VSIX 文件
3. 上传到 VSCode Marketplace
4. 显示发布结果

**成功输出示例**：
```
✅ Published QINGYUAI.svn-git-auto-commit v0.1.2
```

#### 步骤 3: 验证发布

1. 访问插件市场页面：
   https://marketplace.visualstudio.com/items?itemName=QINGYUAI.svn-git-auto-commit

2. 检查版本号是否正确更新

3. 等待几分钟后，在 VSCode 中搜索插件，确认新版本可用

### 方法二：手动上传 VSIX 文件

#### 步骤 1: 打包 VSIX 文件

```bash
vsce package
```

#### 步骤 2: 访问发布管理页面

访问：https://marketplace.visualstudio.com/manage/publishers/QINGYUAI/extensions/svn-git-auto-commit/hub

#### 步骤 3: 上传新版本

1. 点击 "New Release" 或 "Update"
2. 上传 VSIX 文件
3. 填写版本说明
4. 点击 "Upload"

### 方法三：发布到 GitHub Releases

#### 步骤 1: 创建 Git Tag

```bash
# 创建版本标签
git tag v0.1.2

# 推送标签到远程
git push origin v0.1.2
```

#### 步骤 2: 创建 GitHub Release

1. 访问：https://github.com/QINGYUAI/svn-auto-vscode/releases/new
2. 选择标签：`v0.1.2`
3. 填写标题：`v0.1.2`
4. 填写发布说明（从 CHANGELOG.md 复制）
5. 上传 VSIX 文件
6. 点击 "Publish release"

---

## 📝 版本管理

### 语义化版本控制

遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范：

- **主版本号（1.0.0）**: 不兼容的 API 修改
- **次版本号（0.1.0）**: 向下兼容的功能性新增
- **修订号（0.0.1）**: 向下兼容的问题修正

### 版本更新检查清单

发布前必须检查：

- [ ] `package.json` 中的版本号已更新
- [ ] `CHANGELOG.md` 已更新新版本内容
- [ ] 所有代码更改已提交到 Git
- [ ] 代码已通过编译和测试
- [ ] README.md 中的信息是最新的
- [ ] 图标文件存在且正确
- [ ] 许可证文件存在

### 自动版本递增

vsce 支持自动递增版本号：

```bash
# 补丁版本（0.1.1 -> 0.1.2）
vsce publish patch

# 次版本（0.1.1 -> 0.2.0）
vsce publish minor

# 主版本（0.1.1 -> 1.0.0）
vsce publish major
```

---

## 🔍 故障排除

### 问题 1: vsce 命令未找到

**错误信息**：
```
'vsce' 不是内部或外部命令
```

**解决方案**：
```bash
# 全局安装
npm install -g @vscode/vsce

# 或使用 npx
npx @vscode/vsce package
```

### 问题 2: 登录失败

**错误信息**：
```
Error: Failed Request: Unauthorized(401)
```

**解决方案**：
1. 检查 Personal Access Token 是否正确
2. 检查 Token 是否过期
3. 重新登录：`vsce login QINGYUAI`
4. 确认组织名称正确

### 问题 3: 打包失败 - 文件未找到

**错误信息**：
```
Error: File not found: dist/extension.js
```

**解决方案**：
```bash
# 先编译项目
npm run package

# 然后再打包
vsce package
```

### 问题 4: 打包失败 - 版本号格式错误

**错误信息**：
```
Error: Invalid version number
```

**解决方案**：
- 确保 `package.json` 中的版本号格式正确：`x.y.z`
- 例如：`0.1.2` ✅，`v0.1.2` ❌，`0.1` ❌

### 问题 5: 发布失败 - 版本已存在

**错误信息**：
```
Error: This version already exists
```

**解决方案**：
- 更新版本号到更高的版本
- 或使用 `vsce publish patch/minor/major` 自动递增

### 问题 6: VSIX 文件过大

**问题**：VSIX 文件超过 50MB

**解决方案**：
1. 检查 `.vscodeignore` 文件，确保排除了：
   - `node_modules/**`
   - `src/**`
   - `test/**`
   - `out/**`
   - `*.ts`
   - `*.map`

2. 检查是否有大文件被包含：
```bash
# 查看 VSIX 文件内容
vsce ls
```

### 问题 7: 发布后插件不可用

**问题**：发布成功但插件市场显示不可用

**解决方案**：
1. 等待 5-10 分钟（市场需要时间同步）
2. 清除 VSCode 缓存并重启
3. 检查插件是否符合 VSCode 版本要求
4. 查看发布管理页面的错误信息

---

## 📋 快速参考命令

### 完整发布流程（一键命令）

```bash
# 1. 更新版本号（手动编辑 package.json）
# 2. 更新 CHANGELOG.md（手动编辑）
# 3. 编译和打包
npm run package && vsce package

# 4. 发布
vsce publish

# 5. 创建 Git 标签
git tag v0.1.2
git push origin v0.1.2
```

### 常用命令

```bash
# 编译（开发模式）
npm run compile

# 编译（生产模式）
npm run package

# 监听模式编译
npm run watch

# 代码检查
npm run lint

# 运行测试
npm test

# 打包 VSIX
vsce package

# 发布到市场
vsce publish

# 查看已安装的扩展
code --list-extensions

# 安装本地 VSIX
code --install-extension svn-git-auto-commit-0.1.2.vsix

# 卸载扩展
code --uninstall-extension QINGYUAI.svn-git-auto-commit
```

---

## 📊 发布检查清单

发布前请确认：

### 代码质量
- [ ] 代码已通过 ESLint 检查
- [ ] 所有测试通过
- [ ] 没有控制台错误
- [ ] 代码已提交到 Git

### 配置检查
- [ ] `package.json` 版本号已更新
- [ ] `CHANGELOG.md` 已更新
- [ ] `README.md` 信息准确
- [ ] `.vscodeignore` 配置正确

### 文件检查
- [ ] `dist/extension.js` 存在且已编译
- [ ] `icon.png` 存在（128x128）
- [ ] `LICENSE` 文件存在
- [ ] 没有包含源代码文件

### 功能测试
- [ ] 插件可以正常激活
- [ ] 所有命令可以正常执行
- [ ] 状态栏显示正常
- [ ] 配置功能正常

### 发布准备
- [ ] vsce 已登录
- [ ] Personal Access Token 有效
- [ ] 版本号符合语义化版本规范
- [ ] 已准备好发布说明

---

## 🔗 相关链接

- **VSCode 扩展开发文档**: https://code.visualstudio.com/api
- **vsce 工具文档**: https://github.com/microsoft/vscode-vsce
- **VSCode Marketplace**: https://marketplace.visualstudio.com/
- **语义化版本规范**: https://semver.org/lang/zh-CN/
- **插件管理控制台**: https://marketplace.visualstudio.com/manage

---

## 📞 获取帮助

如果遇到问题：

1. 查看本文档的 [故障排除](#故障排除) 部分
2. 查看 [VSCode 扩展开发文档](https://code.visualstudio.com/api)
3. 提交 [GitHub Issue](https://github.com/QINGYUAI/svn-auto-vscode/issues)
4. 查看 [vsce 文档](https://github.com/microsoft/vscode-vsce)

---

**最后更新**: 2025-11-20  
**文档版本**: 1.0

